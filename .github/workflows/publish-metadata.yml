name: Publish Metadata to Elasticsearch

on:
  push:
    paths:
      - '**/*_metadata.json'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Push metadata to Elasticsearch with embeddings
        if: github.event_name == 'push'
        env:
          EMBEDDINGS_URL: ${{ secrets.EMBEDDINGS_URL }}
          ES_URL: ${{ secrets.ES_URL }}
          BEFORE_SHA: ${{ github.event.before }}
          AFTER_SHA: ${{ github.sha }}
        run: |
          python - <<'EOF'
          import os, subprocess, json, requests

          before = os.environ['BEFORE_SHA']
          after = os.environ['AFTER_SHA']
          es_url = os.environ['ES_URL'] + "/artifacts/_doc"
          embed_url = os.environ['EMBEDDINGS_URL']

          # Find changed metadata files
          if not before or before == "0000000000000000000000000000000000000000":
              files = subprocess.check_output(["git", "ls-files", "*_metadata.json"], text=True).splitlines()
          else:
              diff = subprocess.check_output(["git", "diff", "--name-only", before, after], text=True).splitlines()
              files = [f for f in diff if f.endswith("_metadata.json")]

          if not files:
              print("No metadata files changed.")
              exit(0)

          for file in files:
              print(f"Publishing {file}")
              with open(file, "r", encoding="utf-8") as f:
                  data = json.load(f)

              # Get Name embedding
              name_resp = requests.post(embed_url, json={"inputs": [data.get("Name","")]})
              name_emb = name_resp.json().get("embeddings", [[]])[0]

              # Get Description embedding
              desc_resp = requests.post(embed_url, json={"inputs": [data.get("Description","")]})
              desc_emb = desc_resp.json().get("embeddings", [[]])[0]

              # Add embeddings to document
              data["Name_embedding"] = name_emb
              data["Description_embedding"] = desc_emb

              # Push to Elasticsearch
              resp = requests.post(es_url, json=data)
              if resp.status_code not in [200, 201]:
                  print(f"Failed to publish {file}: {resp.text}")
              else:
                  print(f"Published {file} successfully.")
          EOF
