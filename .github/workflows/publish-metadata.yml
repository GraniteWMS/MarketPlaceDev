name: Publish Metadata to Elasticsearch

on:
  push:
    paths:
      - '**/*_metadata.json'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed metadata files
        id: changed_files
        shell: pwsh
        run: |
          $before = "${{ github.event.before }}"
          $after = "${{ github.sha }}"
          if (-not $before -or $before -eq "0000000000000000000000000000000000000000") {
            $changed = git ls-files *"_metadata.json"
          } else {
            $changed = git diff --name-only $before $after | Where-Object { $_ -like "*_metadata.json" }
          }
          if (-not $changed) {
            Write-Host "No metadata files changed."
            echo "files=" >> $env:GITHUB_OUTPUT
            exit 0
          }
          $list = $changed -join ","
          echo "files=$list" >> $env:GITHUB_OUTPUT

      - name: Push metadata to Elasticsearch with embeddings
        if: steps.changed_files.outputs.files != ''
        run: |
          import os, json, requests

          files = "${{ steps.changed_files.outputs.files }}".split(",")
          embedding_url = os.environ["EMBEDDINGS_URL"]
          es_url = os.environ["ES_URL"].rstrip("/") + "/artifacts/_doc"

          for file in files:
              print(f"Publishing {file}")
              with open(file, "r", encoding="utf-8") as f:
                  data = json.load(f)

              # Ensure we always work with a list of objects
              if isinstance(data, dict):
                  data = [data]

              for obj in data:
                  name_text = obj.get("Name", "")
                  desc_text = obj.get("Description", "")

                  # Call embeddings service
                  name_emb = requests.post(embedding_url, json={"inputs": [name_text]}).json()
                  desc_emb = requests.post(embedding_url, json={"inputs": [desc_text]}).json()

                  obj["Name_embedding"] = name_emb
                  obj["Description_embedding"] = desc_emb

                  # Index into Elasticsearch
                  resp = requests.post(es_url, json=obj)
                  resp.raise_for_status()
                  print(f"Indexed {file} -> {resp.json()}")

        env:
          EMBEDDINGS_URL: ${{ secrets.EMBEDDINGS_URL }}
          ES_URL: ${{ secrets.ES_URL }}
