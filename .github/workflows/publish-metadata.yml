name: Publish Metadata to Elasticsearch

on:
  push:
    paths:
      - '**/*_metadata.json'   # only trigger when metadata files change

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch all history so diffs work

      - name: Find changed metadata files
        id: changed_files
        shell: pwsh
        run: |
          $before = "${{ github.event.before }}"
          $after = "${{ github.sha }}"
          if (-not $before -or $before -eq "0000000000000000000000000000000000000000") {
            # First commit in repo or branch creation
            $changed = git ls-files *"_metadata.json"
          } else {
            $changed = git diff --name-only $before $after | Where-Object { $_ -like "*_metadata.json" }
          }
          if (-not $changed) {
            Write-Host "No metadata files changed."
            echo "files=" >> $env:GITHUB_OUTPUT
            exit 0
          }
          $list = $changed -join ","
          echo "files=$list" >> $env:GITHUB_OUTPUT

      - name: Push metadata to Elasticsearch with embeddings
        if: steps.changed_files.outputs.files != ''
        shell: pwsh
        run: |
          $files = "${{ steps.changed_files.outputs.files }}".Split(",")
          $embeddingUrl = "${{ secrets.EMBEDDINGS_URL }}"  # e.g., http://embeddings:8080/embed
          $esUrl = "${{ secrets.ES_URL }}/artifacts/_doc"

          foreach ($file in $files) {
            Write-Host "Publishing $file"
            $json = Get-Content $file -Raw | ConvertFrom-Json

            # Generate Name embedding
            $nameEmb = Invoke-RestMethod -Uri $embeddingUrl -Method POST -Body (@{inputs = @($json.Name)} | ConvertTo-Json) -ContentType "application/json"
            $json.Name_embedding = $nameEmb.embeddings[0]

            # Generate Description embedding
            $descEmb = Invoke-RestMethod -Uri $embeddingUrl -Method POST -Body (@{inputs = @($json.Description)} | ConvertTo-Json) -ContentType "application/json"
            $json.Description_embedding = $descEmb.embeddings[0]

            # Convert back to JSON and push to Elasticsearch
            $jsonBody = $json | ConvertTo-Json -Depth 10
            Invoke-RestMethod -Uri $esUrl -Method POST -Body $jsonBody -ContentType "application/json"
          }
