name: Publish Metadata to Elasticsearch

on:
  push:
    paths:
      - '**/*_metadata.json'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Publish metadata to Elasticsearch with embeddings
        env:
          EMBEDDINGS_URL: ${{ secrets.EMBEDDINGS_URL }}
          ES_URL: ${{ secrets.ES_URL }}
        run: |
          python3 - <<'PYTHON_EOF'
          import os, json, requests, glob

          EMBEDDINGS_URL = os.environ["EMBEDDINGS_URL"]
          ES_URL = os.environ["ES_URL"].rstrip("/") + "/artifacts/_doc"

          # find all metadata files
          files = glob.glob("*_metadata.json")
          if not files:
              print("No metadata files found. Exiting.")
              exit(0)

          for file_path in files:
              print(f"Publishing {file_path}...")
              with open(file_path, "r", encoding="utf-8") as f:
                  data = json.load(f)

              # Add embeddings
              name_text = data.get("Name", "")
              desc_text = data.get("Description", "")

              data["Name_embedding"] = requests.post(EMBEDDINGS_URL, json={"inputs":[name_text]}).json()["embeddings"][0]
              data["Description_embedding"] = requests.post(EMBEDDINGS_URL, json={"inputs":[desc_text]}).json()["embeddings"][0]

              # Post to Elasticsearch
              resp = requests.post(ES_URL, json=data)
              resp.raise_for_status()
              print(f"Indexed {file_path} -> success")
          PYTHON_EOF
