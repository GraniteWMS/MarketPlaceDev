name: Publish Metadata to Elasticsearch

on:
  push:
    paths:
      - '**/*_metadata.json'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push changed metadata to Elasticsearch
        env:
          EMBEDDINGS_URL: ${{ secrets.EMBEDDINGS_URL }}
          ES_URL: ${{ secrets.ES_URL }}
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python3 - <<'PYTHON_EOF'
          import os, json, requests, subprocess

          EMBEDDINGS_URL = os.environ["EMBEDDINGS_URL"]
          ES_URL = os.environ["ES_URL"].rstrip("/") + "/artifacts/_doc"
          before = os.environ.get("GITHUB_EVENT_BEFORE")
          after = os.environ.get("GITHUB_SHA")

          # Determine changed metadata files
          if not before or before == "0000000000000000000000000000000000000000":
              # first commit, take all _metadata.json files
              changed_files = subprocess.check_output(
                  ["git", "ls-files", "*_metadata.json"], text=True
              ).splitlines()
          else:
              diff = subprocess.check_output(
                  ["git", "diff", "--name-only", before, after], text=True
              ).splitlines()
              changed_files = [f for f in diff if f.endswith("_metadata.json")]

          if not changed_files:
              print("No changed metadata files. Exiting.")
              exit(0)

          for file_path in changed_files:
            print(f"Publishing {file_path}...")
            with open(file_path, "r", encoding="utf-8") as f:
                data = json.load(f)
        
            name_text = data.get("Name", "")
            desc_text = data.get("Description", "")
        
            # Correct embedding extraction
            resp = requests.post(EMBEDDINGS_URL, json={"inputs":[name_text]})
            print("DEBUG response:", resp.text)
            name_embedding = resp.json()["value"]
            data["Name_embedding"] = name_embedding            
            
            resp = requests.post(EMBEDDINGS_URL, json={"inputs":[desc_text]})
            desc_embedding = resp.json()["value"]
            data["Description_embedding"] = desc_embedding
        
            resp = requests.post(ES_URL, json=data)
            resp.raise_for_status()
            print(f"Indexed {file_path} -> success")

          PYTHON_EOF
