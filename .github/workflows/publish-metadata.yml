name: Publish Metadata to Elasticsearch

on:
  push:
    paths:
      - '**/*_metadata.json'   # only trigger when metadata files change

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Find changed metadata files
        id: changed_files
        shell: pwsh
        run: |
          $before = "${{ github.event.before }}"
          $after = "${{ github.sha }}"

          if (-not $before -or $before -eq "0000000000000000000000000000000000000000") {
            # First commit in repo or branch creation
            $changed = git ls-files *"_metadata.json"
          } else {
            $changed = git diff --name-only $before $after | Where-Object { $_ -like "*_metadata.json" }
          }

          if (-not $changed) {
            Write-Host "No metadata files changed."
            echo "files=" >> $env:GITHUB_OUTPUT
            exit 0
          }

          $list = $changed -join ","
          echo "files=$list" >> $env:GITHUB_OUTPUT


      - name: Push metadata to Elasticsearch
        if: steps.changed_files.outputs.files != ''
        shell: pwsh
        run: |
          $files = "${{ steps.changed_files.outputs.files }}".Split(",")
          foreach ($file in $files) {
            Write-Host "Publishing $file"
            $json = Get-Content $file -Raw
            Invoke-RestMethod -Uri "${{ secrets.ES_URL }}/artifacts/_doc" -Method POST -Body $json -ContentType "application/json"
          }
